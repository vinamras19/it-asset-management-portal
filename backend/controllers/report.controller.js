import PDFDocument from "pdfkit";
import Asset from "../models/asset.model.js";
import Ticket from "../models/ticket.model.js";
import AuditLog from "../models/auditLog.model.js";

export const generateAssetReport = async (req, res) => {
    try {
        const assets = await Asset.find({}).populate("assignedTo", "name department");

        const doc = new PDFDocument();
        const filename = `Asset_Inventory_${Date.now()}.pdf`;

        res.setHeader("Content-disposition", `attachment; filename="${filename}"`);
        res.setHeader("Content-type", "application/pdf");

        doc.pipe(res);


        doc.fontSize(20).text("IT Asset Inventory Report", { align: "center" });
        doc.moveDown();
        doc.fontSize(10).text(`Generated by: ${req.user.name} | Date: ${new Date().toLocaleDateString()}`, { align: "center" });
        doc.moveDown();


        assets.forEach((asset, i) => {
            if (doc.y > 700) doc.addPage();

            doc.fontSize(12).text(`${i + 1}. ${asset.name} (${asset.assetTag})`, { continued: true });
            doc.fontSize(10).text(` - ${asset.status.toUpperCase()}`, { align: "right" });

            doc.fontSize(9).text(`   Category: ${asset.category} | SN: ${asset.serialNumber}`);
            doc.text(`   Location: ${asset.location} | Assigned: ${asset.assignedTo?.name || "Unassigned"}`);
            doc.moveDown(0.5);
        });

        doc.end();

    } catch (error) {
        console.error("Report Generation Error:", error);
        if (!res.headersSent) res.status(500).json({ message: "Could not generate report" });
    }
};

export const generateTicketReport = async (req, res) => {
    try {
        const tickets = await Ticket.find({}).populate("user", "name").sort({ status: 1 });

        const doc = new PDFDocument();
        const filename = `Ticket_Report_${Date.now()}.pdf`;

        res.setHeader("Content-disposition", `attachment; filename="${filename}"`);
        res.setHeader("Content-type", "application/pdf");

        doc.pipe(res);

        doc.fontSize(20).text("Help Desk Ticket Summary", { align: "center" });
        doc.moveDown();

        tickets.forEach((ticket, i) => {
            if (doc.y > 700) doc.addPage();

            const color = ticket.status === 'Open' ? 'red' : 'black';

            doc.fillColor(color).fontSize(12).text(`[${ticket.status}] ${ticket.ticketNumber}: ${ticket.title}`);
            doc.fillColor('black').fontSize(9).text(`   Raised by: ${ticket.user.name} | Priority: ${ticket.priority}`);
            doc.moveDown(0.5);
        });

        doc.end();

    } catch (error) {
        console.error("Report Generation Error:", error);
        if (!res.headersSent) res.status(500).json({ message: "Could not generate report" });
    }
};

export const generateAuditReport = async (req, res) => {
    try {
        const logs = await AuditLog.find({}).sort({ createdAt: -1 }).limit(500).populate("userId", "name email");

        const doc = new PDFDocument();
        const filename = `Security_Audit_Log_${Date.now()}.pdf`;

        res.setHeader("Content-disposition", `attachment; filename="${filename}"`);
        res.setHeader("Content-type", "application/pdf");

        doc.pipe(res);

        doc.fontSize(20).text("System Security Audit Log", { align: "center" });
        doc.fontSize(10).text("Last 500 Actions", { align: "center" });
        doc.moveDown();

        logs.forEach((log) => {
            if (doc.y > 700) doc.addPage();

            doc.fontSize(10).text(`${new Date(log.createdAt).toLocaleString()} - ${log.action}`);
            doc.fontSize(8).text(`   User: ${log.userId?.name || 'System'} | IP: ${log.ipAddress} | Status: ${log.status}`);
            doc.moveDown(0.2);
        });

        doc.end();

    } catch (error) {
        console.error("Report Generation Error:", error);
        if (!res.headersSent) res.status(500).json({ message: "Could not generate report" });
    }
};

export const generateUserAssetsReport = async (req, res) => {

    res.status(501).json({ message: "Not implemented yet" });
};